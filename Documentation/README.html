<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>EnergyShield &lpar;ICCPS &apos;23&comma; Submission 251&rpar;</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <h1 id="energyshield-iccps-23-submission-251">EnergyShield (ICCPS '23, Submission 251)</h1>
<p>EnergyShield is an Autonomous Driving System framework designed to save energy on-vehicle by wirelessly offloading NN computations to edge computers, while at the same time maintaining a formal guarantee of safety. In particular, EnergyShield uses a barrier function/controller shield to provide provably safe edge response times for NN offloading requests; on vehicle evaluation provides a safety fallback.</p>
<p>EnergyShield is described in the paper:</p>
<blockquote>
<p><em>EnergyShield: Provably-Safe Offloading of Neural Network Controllers for Energy Efficiency.</em><br>
Mohanad Odema, James Ferlez, Goli Vaisi, Yasser Shoukry and Mohammad Abdullah Al Faruque. ICCPS 2023: 14th ACM/IEEE International Conference on Cyber-Physical Systems.</p>
</blockquote>
<p>also enclosed as <code>ICCPS23_251.pdf</code>, and hereafter referred to as [EnergyShield-ICCPS23].</p>
<p>[EnergyShield-ICCPS2023] contains a number of experiments showing the efficacy of EnergyShield in the <a href="https://carla.org">Carla</a> simulation environment. This README describes how to replicate those results using code packaged in a <a href="https://docs.docker.com/engine/">Docker</a> image. In particular, this artifact reruns from scratch the following experiments from [EnergyShield-ICCPS2023]:</p>
<pre><code>(Experiment 1) Energy Efficiency and Safety Evaluation of EnergyShield through Carla Simulation runs (Section 5.2)
(Experiment 2) Performance Gains from EnergyShield given wireless channel variation (Section 5.3)
(Experiment 3) Generality to other neural network controllers (Section 5.4) 
</code></pre>
<p>For each of these experiments, this artifact re-generates both new raw data and the analogous plots shown in [EnergyShield-ICCPS2023].</p>
<h2 id="contents">Contents</h2>
<ol start="0">
<li>Terminology</li>
<li>System Requirements</li>
<li>Setup</li>
<li>Experiment 1 - Energy Efficiency and Safety Evaluation</li>
<li>Experiment 2 - Performance under wireless channel variation</li>
<li>Experiment 3 - Performance Statistics</li>
<li>Appendix</li>
</ol>
<h2 id="0-terminology">0. Terminology</h2>
<p>This repeatability artifact uses <a href="https://docs.docker.com/engine/">Docker</a>. We will use the following terminology throughout:</p>
<ul>
<li>The <strong>HOST</strong> will refer to the system running Docker (e.g. your laptop).</li>
<li>The <strong>CONTAINER</strong> will refer to the &quot;virtualized&quot; system created by Docker (this is where the code from the artifact is run).</li>
</ul>
<p>Commands meant to be executed from a shell on the host or the container will be prefixed with one of the following comments, respectively:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; HOST COMMANDS &gt;&gt;&gt;</span>
<span class="hljs-comment"># &lt;&lt;&lt; CONTAINER COMMANDS &gt;&gt;&gt;</span>
</code></pre>
<h2 id="1-system-requirements">1. System Requirements</h2>
<p><strong>HARDWARE (HOST):</strong></p>
<ol>
<li>An x86-64 CPU</li>
<li>32GB of RAM</li>
<li>An NVIDIA GPU with 8GB of VRAM <strong>(Geforce 20xx series or later; GTX 2080Ti and V100 cards were tested)</strong>; headless GPUs will work (e.g. servers and Amazon EC2/Microsoft Azure instances)</li>
<li>At least 100GB of free disk space on the filesystem where Docker stores images (the filesystem containing <code>/var/lib/docker</code> <a href="https://docs.docker.com/config/daemon/#daemon-data-directory">by default</a>)</li>
</ol>
<p><strong>SOFTWARE (HOST):</strong></p>
<ol>
<li>Un-virtualized Linux operating system; headless and cloud (e.g. Amazon EC2/Microsoft Azure) installs will work (tested on Ubuntu 20.04, but any distribution that meets the remaining requirements should work)</li>
<li>Official <a href="https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html">Linux NVIDIA drivers</a> <strong>(version &gt;= 515.76 is **<em>REQUIRED</em>**)</strong></li>
<li>A recent version of <a href="https://docs.docker.com/engine/">Docker Engine</a> <strong>(version &gt;= 19.03)</strong>; also known as Docker Server but <strong>not</strong> <a href="https://docker.com">Docker Desktop</a></li>
<li>A recent version of <code>git</code> on the path</li>
<li>The <code>bash</code> shell installed in <code>/bin/bash</code></li>
<li>A user account that can run Docker containers in priviledged mode (i.e. with the <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities"><code>--priviledged</code> switch</a>)</li>
</ol>
<blockquote>
<p><strong>WARNING:</strong> NVIDIA driver version &gt;=515.76 is a <strong>STRICT REQUIREMENT</strong>. This repeatability artifact <strong>WILL NOT WORK</strong> unless the host has official NVIDIA drivers version 515.76 or higher installed.</p>
</blockquote>
<h2 id="2-setup">2. Setup</h2>
<h3 id="i-host-paths"><em>(i) Host Paths</em></h3>
<p>Choose an install location on the host:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; HOST COMMANDS &gt;&gt;&gt;</span>
HOST_LOCATION=/path/to/some/place/convenient
<span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$HOST_LOCATION</span>&quot;</span>
</code></pre>
<blockquote>
<p><strong>NOTE:</strong> All subsequent <strong>HOST</strong> paths in this readme are assumed to be relative to <code>$HOST_LOCATION</code>.</p>
</blockquote>
<h3 id="ii-starting-the-docker-container"><em>(ii) Starting the Docker Container</em></h3>
<p>To start the EnergyShield Docker container, execute the following in a Bash shell on the host (from <code>$HOST_LOCATION</code>):</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; HOST COMMANDS &gt;&gt;&gt;</span>
git <span class="hljs-built_in">clone</span> --recursive https://github.com/MohanadOdema/EnergyShield
<span class="hljs-built_in">cd</span> EnergyShield
./dockerbuild.sh <span class="hljs-comment"># WARNING: downloads ~30GB of data, and may take &gt; 1 hour even after download!</span>
./dockerrun.sh --interactive --start-carla
</code></pre>
<p>This should place you at a Bash shell inside a container with EnergyShield installed. The container's Bash shell will have a prompt that looks like:</p>
<pre><code class="language-Bash">carla@ece2ade62bc5:~$ 
</code></pre>
<p>where <code>ece2ade62bc5</code> is a unique container id (i.e. yours will be different).</p>
<blockquote>
<p><strong>WARNING:</strong> if you exit the container's Bash shell, then the <strong>container and all experiments will stop</strong>. You may restart the container with the <strong>host</strong> command:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; HOST COMMANDS &gt;&gt;&gt;</span>
./dockerrun.sh --interactive --start-carla
</code></pre>
<p><strong>NOTE:</strong> There is no need to rerun <code>dockerbuild.sh</code> when restarting the container in this fashion.</p>
</blockquote>
<h3 id="iii-testing-the-container"><em>(iii) Testing the Container</em></h3>
<p>From the <strong>container</strong>'s Bash shell execute:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; CONTAINER COMMANDS &gt;&gt;&gt;</span>
ps | grep Carla
</code></pre>
<p>You should see output listing two processes related to <a href="https://carla.org">Carla</a>:</p>
<pre><code class="language-Bash">     45 pts/0    00:00:00 CarlaUE4.sh
     52 pts/0    00:01:00 CarlaUE4-Linux-
</code></pre>
<blockquote>
<p><strong>WARNING:</strong> if the above command produces no output, then Carla is not running, and this repeatability artifact <strong>WILL NOT WORK</strong>.</p>
<p><strong>FIX:</strong> Double check that your host system meets the requirements in Section 1, especially the NVIDIA driver requirements (incorrect NVIDIA drivers are usually what prevents Carla from starting). If your system meets these requirements, then try restarting the container using the following sequence of commands:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; CONTAINER COMMANDS &gt;&gt;&gt;</span>
<span class="hljs-comment"># Exit from the container if it&#x27;s still running:</span>
<span class="hljs-built_in">exit</span>
</code></pre>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; HOST COMMANDS &gt;&gt;&gt;</span>
./dockerrun.sh --remove <span class="hljs-comment"># Remove any existsing container</span>
./dockerrun.sh --interactive --start-carla
</code></pre>
</blockquote>
<h2 id="3-experiment-1---energy-efficiency-and-safety-evaluation">3. Experiment 1 - Energy Efficiency and Safety Evaluation</h2>
<p>In this experiment, we compared EnergyShield with purely on-vehicle NN controller evaluation, both in terms of energy consumption and safety; see [EnergyShield-ICCPS2023], Section 5.2. This comparison was made using a single RL-trained NN controller driving a fixed track; safety entails avoiding randomly spawned stationary obstacles along this track. This artifact reuses the same track and NN controller from our experiment, but the obstacle locations and instantaneous wireless-link performance are randomized.</p>
<p>To rerun this experiment, execute the following commands in the <strong>container</strong>:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; CONTAINER COMMANDS &gt;&gt;&gt;</span>
<span class="hljs-built_in">cd</span> /home/carla/EnergyShield
<span class="hljs-comment"># Run Experiment 1 Carla simulation</span>
./scripts/run_exp1.sh NUM_EPS
</code></pre>
<!-- `model` is the name of the pretrained model directory(default: "casc_agent_1_new"). Users do not need to alter this argument for it indicates new simulation experiments using our pretrained RL model. -->
<p><code>NUM_EPS</code> is an optional argument specifying the number of episodes to run (default: <code>NUM_EPS=3</code>); an episode is defined as one run of the fixed track until either the vehicle completes the track or hits an obstacle. For [EnergyShield-ICCPS2023], we ran this experiment for 35 episodes.</p>
<blockquote>
<p><strong>NOTE:</strong>  Running this script with the default <code>NUM_EPS=3</code>  takes around 1 hour on a workstation with 32 GB RAM and NVIDIA GPU 2070 RTX super.</p>
</blockquote>
<blockquote>
<p><strong>NOTE:</strong> When the script finishes, you will be returned to a shell prompt in the container (see Section 1). If the script is successfully running, status information will be output to the console regularly.</p>
</blockquote>
<!-- `NUM_EPS` is an optional argument describing the number of episodes per experimental configuration (default: 3). Note that although `NUM_EPS` in our paper was 35, we kept it here at 3 to speed up the simulation runs for the evaluators. From our experience, running the script with `NUM_EPS` set to 3 takes around 1 hour of computation time on a workstation with 32 GB RAM and NVIDIA GPU 2070 RTX super. 

Once the simulations terminate, raw data generated by carla simulations are copied to `../results/raw_data/`. The raw data provides information and statistics on the agent's performance based on its driving and offloading decisions. For convenience, we provide a description of the file hierarchy and what each data field represents in this readme's appendix.  -->
<p>The primary outputs of this script are figures that summarize the energy savings and safety properties of EnergyShield (across the number of episodes specified by <code>NUM_EPS</code>). These figures can be found on the <strong>HOST</strong> at the following paths:</p>
<pre><code class="language-Bash"><span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig5_Energy.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig5_Safety.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig6_traj_noise_False.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig6_traj_noise_True.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig7_Ergy_v_dist.pdf
</code></pre>
<p>Their filenames match them to the figures that appear in [EnergyShield-ICCPS2023]. For reference, the figures from [EnergyShield-ICCPS2023] are also available with the same filenames in <code>$HOST_LOCATION/paper_results</code>.</p>
<p>This script also outputs the raw Carla simulation data of each episode (i.e. the simulation time-stamped positions, velocities, etc. of the vehicle); this data is placed in <code>$HOST_LOCATION/container_results/raw_data</code>; the analogous raw data from our simulations can be found in <code>$HOST_LOCATION/paper_results/raw_data</code> for comparison. The format and structure of this data is described in the subsequent section <strong>6. Appendix</strong>.</p>
<p>Finally, Figure 7 (Energy vs. distance) is derived from some summary statistics of raw data noted above; these summaries are produced as several <code>.CSV</code> files output to <code>$HOST_LOCATION/container_results/distance/*.csv</code>.</p>
<!-- Afterwards, figures 5, 6, and 7 can be generated in .pdf format based on the raw data in the below paths. We remark the following:
- Figure 6 trajectories are generated based on 3 random episodes from the user's generated files. The figure may not possess the same driving patterns as ours for it depends on the RL agent's driving decisions (For instance, in an extreme corner cases, vehicle's trajectory can be a point indicating the RL agent remained stationary)
- Figure 7 (Energy vs. distance) is generated based on statistical representation of raw data in `../results/distance/*.csv` - also described in the appendix.  -->
<h2 id="4-experiment-2---performance-under-wireless-channel-variation">4. Experiment 2 - Performance under wireless channel variation</h2>
<p>In this experiment, we evaluated the energy savings provided by EnergyShield as a function of different wireless-link conditions to the edge; see [EnergyShield-ICCPS2023], Section 5.3. This experiment uses mostly the same setup as Experiment 1, including the same NN controller and track. However, in this experiment, batches of episodes are run under five different simulated wireless-link conditions. As before, this artifact reuses the same track and NN controller from our experiment, but the obstacle locations and instantaneous wireless-link performance are randomized.</p>
<!-- In 5.3, Additional Carla simulations are conducted to evaluate EnergyShield's resilience under variations of wireless network conditions, which are represented in this paper by the parameters of channel throughput and queuing delays. To run these additional simulations, users can run the following script: -->
<p>To rerun this experiment, execute the following commands in the <strong>container</strong>:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; CONTAINER COMMANDS &gt;&gt;&gt;</span>
<span class="hljs-built_in">cd</span> /home/carla/EnergyShield
<span class="hljs-comment"># Run Experiment 2 Carla simulations:</span>
./scripts/run_exp2.sh NUM_EPS
</code></pre>
<p>The optional parameter <code>NUM_EPS</code> has a similar interpretation to Experiment 1 (default <code>NUM_EPS=3</code>), but here it represents the number of episodes to run under each wireless-link condition (of which this experiment contains five).</p>
<blockquote>
<p><strong>NOTE:</strong>  Running this script with the default <code>NUM_EPS=3</code>  takes around 2 - 3 hours on a workstation with 32 GB RAM and NVIDIA GPU 2070 RTX super.</p>
</blockquote>
<blockquote>
<p><strong>NOTE:</strong> When the script finishes, you will be returned to a shell prompt in the container (see Section 1). If the script is successfully running, status information will be output to the console regularly.</p>
</blockquote>
<!-- This script will instantiate 5 additional experiments of varying wireless conditions. Once the simulations are terminated, their corresponding raw data files are copied to `../results/raw_data`, which are then used to generate the box and whisker plots of Figures 8 and 9 describing additional offloading windows (%) and the normalized energy consumption (w.r.t local execution) under different wireless conditions:  -->
<!-- ```Bash
# Experiment 2 Figures' Generation
sh ./scripts/exp2_generate_results.sh
``` -->
<p>The primary outputs of this script are figures that summarize the energy performance of EnergyShield under these different wireless conditions, including the number of local-execution fallbacks required. These figures can be found on the <strong>HOST</strong> at the following paths:</p>
<pre><code class="language-Bash"><span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig8_windows.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig9_energy.pdf
</code></pre>
<p>As before, their filenames match them to the figures that appear in [EnergyShield-ICCPS2023]. Likewise, the figures from [EnergyShield-ICCPS2023] are also available with the same filenames in <code>$HOST_LOCATION/paper_results</code>.</p>
<p>The raw data from this experiment is similarly placed in <code>$HOST_LOCATION/container_results/raw_data</code>, and the analogous raw data from our simulations is in <code>$HOST_LOCATION/paper_results/raw_data</code> for comparison. See the the subsequent section <strong>6. Appendix</strong> for a description of the format and structure of this raw data.</p>
<h2 id="5-experiment-3---performance-statistics">5. Experiment 3 - Performance Statistics</h2>
<p>This last script generates a <code>.csv</code> file describing the performance statistics of the user's model in accordance with the metrics in Table 1. These performance metrics are the average center deviance (CD), Track Completion Rate (TCR), and average energy consumption (E) based on the generated results from the users' experiments as follows:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># &lt;&lt;&lt; CONTAINER COMMANDS &gt;&gt;&gt;</span>
<span class="hljs-built_in">cd</span> /home/carla/EnergyShield
<span class="hljs-comment"># Run Experiment 3 generate model statistics</span>
./scripts/exp3_generate_results.sh
</code></pre>
<p>The results will be displayed in the terminal and saved in <code>.csv</code> format under the path <code>$HOST_LOCATION/container_results/stats_for_casc_agent_1_new.csv</code>.</p>
<!-- can be set to one of {"casc_agent_1", "casc_agent_2", "casc_agent_3", "casc_agent_4"} to generate our exact numbers. -->
<h2 id="6-appendix">6. Appendix</h2>
<p>Raw Data</p>
<p>Under <code>$HOST_LOCATION/container_results/raw_data/</code>, every directory describes the evaluation results for a set of episodes. The name suffix of each directory describes the experimental configuration setting these evaluations belong to. For instance:</p>
<ul>
<li>Directory <code>Town04_OPT_ResNet152_Shield2_early</code>: experiment1 evaluations for EnergyShield early mode at default wireless settings</li>
<li>Directory <code>Town04_OPT_ResNet152_Shield2_belay_10Mbps</code>: experiment2 evaluations for EnergyShield uniform mode when varying wireless channel throughput to 10Mbps</li>
</ul>
<p>Within each of these directories, four subdirectories exist to describe whether the experiments were conducted with/without gaussian noise and with/without safety filter activated. In each one of these subdirectories, we can find the experimental data in <code>*.csv</code> format as follows:</p>
<ul>
<li><code>plots/*.csv</code> files containing the individual episode's data incurred by the carla simulator when running each episode for the corresponding experimental setting.</li>
<li><code>valid_data.csv</code> is the file describing the final statistics for every episode within the corresponding experimental configuration</li>
</ul>
<p>Information in the former include simulation time, position, steering angle, relative obstacle position, wireless conditions, safety time window, offloading actions, and performance evaluations in terms of latency and energy - all calculated instantaneously for every simulation tick.</p>
<p>Information in the latter include statistics for each episode about total number of ticks, reward, distance traveled, speed, average latency, average energy per inference, average center deviance, and whether the agent has hit an obstacle/curb.</p>
<p>Distance data</p>
<p>For figure 7 (normalized energy variation vs distance (meters)), raw data is used to construct the tables in <code>$HOST_LOCATION/container_results/distance/*.csv</code> which aggregate average normalized energy consumption and #occurrences across 1 m increments of 'distance from obstacle' parameter from all episodes within the subdirectory. Each of these tables is then used to construct a plot from the figure describing how this relation varies under different experimental settings.</p>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </body>
    </html>