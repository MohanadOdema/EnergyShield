<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>EnergyShield &lpar;ICCPS &apos;23&comma; Submission 251&rpar;</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <h1 id="energyshield-iccps-23-submission-251">EnergyShield (ICCPS '23, Submission 251)</h1>
<p>EnergyShield is a framework for provably-safe offloading of neural network controllers at the edge. It is described in the paper:</p>
<blockquote>
<p><em>EnergyShield: Provably-Safe Offloading of Neural Network Controllers for Energy Efficiency.</em><br>
Mohanad Odema, James Ferlez, Goli Vaisi, Yasser Shoukry and Mohammad Abdullah Al Faruque. ICCPS 2023: 14th ACM/IEEE International Conference on Cyber-Physical Systems.</p>
</blockquote>
<p>also enclosed as <code>ICCPS23_251.pdf</code>, and hereafter referred to as [EnergyShield-ICCPS23].</p>
<p>This README describes how to replicate the results in [EnergyShield-ICCPS2023] using code packaged in a provided Docker image. This includes generating new experimental data from new Carla simulation instances and creating plots for three numerical experiments:</p>
<pre><code>(Experiment 1) Energy Efficiency and Safety Evaluation of EnergyShield through Carla Simulation runs (Section 5.2)
(Experiment 2) Performance Gains from EnergyShield given wireless channel variation (Section 5.3)
(Experiment 3) Generality to other neural network controllers (Section 5.4) 
</code></pre>
<h2 id="contents">Contents</h2>
<ol start="0">
<li>Terminology</li>
<li>System Requirements</li>
<li>Setup</li>
<li>Experiment 1 - Energy Efficiency and Safety Evaluation</li>
<li>Experiment 2 - Performance under wireless channel variation</li>
<li>Experiment 3 - Performance Statistics</li>
<li>Appendix</li>
</ol>
<h2 id="0-terminology">0. Terminology</h2>
<p>This repeatability artifact uses <a href="https://docker.com">Docker</a>. We will use the following terminology throughout:</p>
<ul>
<li>The <strong>HOST</strong> will refer to the system running Docker (e.g. your laptop).</li>
<li>The <strong>CONTAINER</strong> will refer to the &quot;virtualized&quot; system created by Docker (this is where the code from the artifact is run).</li>
</ul>
<p>Commands meant to be executed inside the host or container will be prefixed with one of the respective comments:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># HOST COMMANDS</span>
<span class="hljs-comment"># CONTAINER COMMANDS</span>
</code></pre>
<h2 id="1-system-requirements">1. System Requirements</h2>
<p><strong>HARDWARE (HOST):</strong></p>
<ol>
<li>An x86-64 CPU</li>
<li>32GB of RAM</li>
<li>An NVIDIA GPU with 8GB of VRAM <strong>(Geforce 20xx series or later; GTX 2080Ti and V100 cards were tested)</strong>; headless GPUs will work (e.g. servers and Amazon EC2/Microsoft Azure instances)</li>
<li>At least 100GB of free disk space</li>
</ol>
<p><strong>SOFTWARE (HOST):</strong></p>
<ol>
<li>Un-virtualized Linux operating system (tested on Ubuntu 20.04 but any distribution that meets the remaining requirements should work; headless installs will work)</li>
<li>Official <a href="https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html">Linux NVIDIA drivers</a> <strong>(version &gt;= 515.76 is **<em>REQUIRED</em>**)</strong></li>
<li>A recent version of <a href="https://docs.docker.com/engine/">Docker Engine</a> <strong>(version &gt;= 19.03)</strong>;  also known as <code>containerd</code> or Docker Server but <strong>not</strong> <a href="https://docker.com">Docker Desktop</a></li>
<li>A recent version of <code>git</code> on the path</li>
<li>The <code>bash</code> shell installed in <code>/bin/bash</code></li>
<li>A user account that can run Docker containers in priviledged mode (i.e. with the <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities"><code>--priviledged</code> switch</a>)</li>
</ol>
<blockquote>
<p><strong>WARNING:</strong> NVIDIA driver version &gt;=515.76 is a <strong>STRICT REQUIREMENT</strong>. This repeatability artifact <strong>WILL NOT WORK</strong> unless the host has official NVIDIA drivers version 515.76 or higher installed.</p>
</blockquote>
<h2 id="2-setup">2. Setup</h2>
<h3 id="i-host-paths"><em>(i) Host Paths</em></h3>
<p>Choose an install location on the host:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># HOST COMMANDS</span>
HOST_LOCATION=/path/to/some/place/convenient
<span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;<span class="hljs-variable">$HOST_LOCATION</span>&quot;</span>
</code></pre>
<blockquote>
<p><strong>NOTE:</strong> All subsequent <strong>HOST</strong> paths in this readme are assumed to be relative to <code>$HOST_LOCATION</code>.</p>
</blockquote>
<h3 id="ii-starting-the-docker-container"><em>(ii) Starting the Docker Container</em></h3>
<p>To start the EnergyShield Docker container, exectute the following in a Bash shell on the host (from <code>$HOST_LOCATION</code>):</p>
<pre><code class="language-Bash"><span class="hljs-comment"># HOST COMMANDS</span>
git <span class="hljs-built_in">clone</span> --recursive https://github.com/MohanadOdema/EnergyShield
<span class="hljs-built_in">cd</span> EnergyShield
./dockerbuild.sh <span class="hljs-comment"># WARNING: downloads ~30GB of data, and may take &gt; 1 hour even after download!</span>
./dockerrun.sh --interactive --start-carla
</code></pre>
<p>This should place you at a Bash shell inside a container with EnergyShield installed. The container's Bash shell will have a prompt that looks like:</p>
<pre><code class="language-Bash">carla@ece2ade62bc5:~$ 
</code></pre>
<p>where <code>ece2ade62bc5</code> is a unique container id (i.e. yours will be different).</p>
<blockquote>
<p><strong>WARNING:</strong> if you exit the container's Bash shell, then the <strong>container and all experiments will stop</strong>. You may restart the container with the <strong>host</strong> command:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># HOST COMMANDS</span>
./dockerrun.sh --interactive --start-carla
</code></pre>
<p><strong>NOTE:</strong> There is no need to rerun <code>dockerbuild.sh</code> when restarting the container in this fashion.</p>
</blockquote>
<h3 id="iii-testing-the-container"><em>(iii) Testing the Container</em></h3>
<p>From the <strong>container</strong>'s Bash shell execute:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># CONTAINER COMMANDS</span>
ps | grep Carla
</code></pre>
<p>You should see output listing two processes related to Carla:</p>
<pre><code class="language-Bash">     45 pts/0    00:00:00 CarlaUE4.sh
     52 pts/0    00:01:00 CarlaUE4-Linux-
</code></pre>
<blockquote>
<p><strong>WARNING:</strong> if the above command produces no output, then Carla is not running, and this repeatability artifact <strong>WILL NOT WORK</strong>.</p>
<p><strong>FIX:</strong> Double check that you have installed the correct NVIDIA drivers on the host (see Section 1). Then restart the container using the following sequence of commands:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># CONTAINER COMMANDS</span>
<span class="hljs-comment"># Exit from the container if it&#x27;s still running:</span>
<span class="hljs-built_in">exit</span>
</code></pre>
<pre><code class="language-Bash"><span class="hljs-comment"># HOST COMMANDS</span>
./dockerrun.sh --remove <span class="hljs-comment"># Remove any existsing container</span>
./dockerrun.sh --interactive --start-carla
</code></pre>
</blockquote>
<h2 id="3-experiment-1---energy-efficiency-and-safety-evaluation">3. Experiment 1 - Energy Efficiency and Safety Evaluation</h2>
<p>As per the description in 5.2, we provide the script to initiate new Carla simulation runs that compare the performance of EnergyShield (with both its eager and uniform modes) to the conventional local execution mode with regards to energy efficiency and safety.</p>
<p>Users can generate their own test results using our pretrained model using the following script:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># CONTAINER COMMANDS</span>
<span class="hljs-built_in">cd</span> /home/carla/EnergyShield
<span class="hljs-comment"># Run Experiment 1 Carla simulation</span>
./scripts/run_exp1.sh NUM_EPS
</code></pre>
<!-- `model` is the name of the pretrained model directory(default: "casc_agent_1_new"). Users do not need to alter this argument for it indicates new simulation experiments using our pretrained RL model. -->
<p><code>NUM_EPS</code> is an optional argument describing the number of episodes per experimental configuration (default: 3). Note that although <code>NUM_EPS</code> in our paper was 35, we kept it here at 3 to speed up the simulation runs for the evaluators. From our experience, running the script with <code>NUM_EPS</code> set to 3 takes around 1 hour of computation time on a workstation with 32 GB RAM and NVIDA GPU 2070 RTX super.</p>
<p>Once the simulations terminate, raw data generated by carla simulations are copied to <code>../results/raw_data/</code>. The raw data provides information and statistics on the agent's performance based on its driving and offloading decisions. For convenience, we provide a description of the file hierarchy and what each data field represents in this readme's appendix.</p>
<p>Afterwards, fgures 5, 6, and 7 can be generated in .pdf formt based on the raw data in the below paths. We remark the following:</p>
<ul>
<li>Figure 6 trajectories are generated based on 3 random episodes from the user's generated files. The figure may not possess the same driving patterns as ours for it depends on the RL agent's driving decisions (For instance, in an extreme corner cases, vehicle's trajectory can be a point indicating the RL agent remained stationary)</li>
<li>Figure 7 (Energy vs. distance) is generated based on statistical representation of raw data in <code>../results/distance/*.csv</code> - also described in the appendix.</li>
</ul>
<p>The figures can be found on the <strong>HOST</strong> at the following paths:</p>
<pre><code class="language-Bash"><span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig5_Energy.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig5_Safety.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig6_traj_noise_False.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig6_traj_noise_True.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig7_Ergy_v_dist.pdf
</code></pre>
<h2 id="4-experiment-2---performance-under-wireless-channel-variation">4. Experiment 2 - Performance under wireless channel variation</h2>
<p>In 5.3, Additional Carla simulations are conducted to evaluate EnergyShield's resilience under variations of wireless network conditions, which are represented in this paper by the parameters of channel throughput and queuing delays. To run these additional simulations, users can run the following script:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># CONTAINER COMMANDS</span>
<span class="hljs-built_in">cd</span> /home/carla/EnergyShield
<span class="hljs-comment"># Run Experiment 2 Carla simulations:</span>
./scripts/run_exp2.sh NUM_EPS
</code></pre>
<p><code>NUM_EPS</code> is the same argument from experiment 1 (default:3). This script will instantiate 5 additional experiments of varying wireless conditions. Once the simulations are terminated, their corresponding raw data files are copied to <code>../results/raw_data</code>, which are then used to generate the box and whisker plots of Figures 8 and 9 describing additional offloading windows (%) and the normalized energy consumption (w.r.t local execution) under different wireless conditions:</p>
<!-- ```Bash
# Experiment 2 Figures' Generation
sh ./scripts/exp2_generate_results.sh
``` -->
<pre><code class="language-Bash"><span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig8_windows.pdf
<span class="hljs-variable">$HOST_LOCATION</span>/container_results/Fig9_energy.pdf
</code></pre>
<h2 id="5-experiment-3---performance-statistics">5. Experiment 3 - Performance Statistics</h2>
<p>This last script generates a <code>.csv</code> file describing the performance statistics of the user's model in accordance with the metrics in Table 1. These performance metrics are the average center deviance (CD), Track Completion Rate (TCR), and average energy consumption (E) based on the generated results from the users' experiments as follows:</p>
<pre><code class="language-Bash"><span class="hljs-comment"># CONTAINER COMMANDS</span>
<span class="hljs-built_in">cd</span> /home/carla/EnergyShield
<span class="hljs-comment"># Run Experiment 3 generate model statistics</span>
./scripts/exp3_generate_results.sh
</code></pre>
<p>The results will be displayed in the terminal and saved in <code>.csv</code> format under the path <code>$HOST_LOCATION/container_results/stats_for_casc_agent_1_new.csv</code>.</p>
<!-- can be set to one of {"casc_agent_1", "casc_agent_2", "casc_agent_3", "casc_agent_4"} to genreate our exact numbers. -->
<h2 id="6-appendix">6. Appendix</h2>
<p>Raw Data</p>
<p>Under <code>$HOST_LOCATION/container_results/raw_data/</code>, every directory describes the evaluation results for a set of episodes. The name suffix of each directory describes the experimental configuration setting these evaluations belong to. For instance:</p>
<ul>
<li>Directory <code>Town04_OPT_ResNet152_Shield2_early</code>: experiment1 evaluations for EnergyShield early mode at default wireless settings</li>
<li>Directory <code>Town04_OPT_ResNet152_Shield2_belay_10Mbps</code>: experiment2 evaluations for EnergyShield uniform mode when varying wireless channel throughput to 10Mbps</li>
</ul>
<p>Within each of these directories, four subdirectories exist to describe whether the experiments were conduceted with/without gaussian noise and with/without safety filter activated. In each one of these subdirectories, we can find the experimental data in <code>*.csv</code> format as follows:</p>
<ul>
<li><code>plots/*.csv</code> files containing the individual episodal data incurred by the carla simulator when running each episode for the corresponding experimental setting.</li>
<li><code>valid_data.csv</code> is the file describing the final statistics for every episode within the corresponding experimental configuration</li>
</ul>
<p>Information in the former include simulation time, position, steering angle, relative obstacle position, wireless conditions, safety time window, offloading actions, and performance evaluations in terms of latency and energy - all calculated instanteously for every simulation tick.</p>
<p>Information in the latter include statistics for each episode about total number of ticks, reward, distance travelled, speed, average latency, average energy per inference, average center deviance, and whether the agent has hit an obstacle/curb.</p>
<p>Distance data</p>
<p>For figure 7 (normalized energy variation vs distance (meters)), raw data is used to construct the tables in <code>$HOST_LOCATION/container_results/distance/*.csv</code> which aggregate average normalized energy consumption and #occurrences across 1 m increments of 'distance from obstacle' parameter from all episodes within the subdirectory. Each of these tables is then used to construct a plot from the figure describing how this relation varies under different experimental settings.</p>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </body>
    </html>